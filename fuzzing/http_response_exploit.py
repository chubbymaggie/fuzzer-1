from logger import *
import requests										# requests HTTP library
import random

class HttpResponseExploit():
	"""
	implements the http response code exploit
	strategy

	If the HTTP response code is not OK (i.e. 200), 
	then something went wrong. Report it.
	"""

	def execute(self, pages, session, strategy):
		"""
		execute strategy
		"""

		vectors = strategy._getVectors()

		logger.info("Sending requests to vectors and checking for status codes other than 200...")

		for page in pages:
			forms = page.get("inputs").get("forms")
			url = page.get("url")

			if strategy.options.random == "False" or strategy.options.random == "false":
				# sequentially
				for form in forms:
					for vector in vectors:

						response = strategy._executeVector(url, vector, form)

						# check if there is a response and test it if it does
						if hasattr(response, 'status_code') :
							if response.status_code != requests.codes.ok:
								logger.info("HTTP Response !200 - \n  Page: %s\n  Form: %s\n  Vector: %s\n  Status:Code: %s\n" 
											% (url,form,vector,response.status_code) )
			else:

				if len(forms) > 0:
					form = random.choice(forms) # randomly choose a form
					for vector in vectors:
						response = strategy._executeVector(url, vector, form)

						# check if there is a response and test it if it does
						if hasattr(response, 'status_code') :
							if response.status_code != requests.codes.ok:
								logger.info("HTTP Response !200 - \n  Page: %s\n  Form: %s\n  Vector: %s\n  Status:Code: %s\n" 
											% (url,form,vector,response.status_code) )