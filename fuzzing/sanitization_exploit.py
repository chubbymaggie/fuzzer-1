from logger import * # logging output
import random

class SanitizationExploit():
	"""
	implements the concrete sanitization exploit
	strategy.

	writes to logger possible sql exploits and when the response hasn't been sanitized of the
	special characters.

	possible exploits are: sql injection, xss exploit, and others that result from
	not sanitizing special characters.

	@toffer
	"""

	def execute(self, pages, session, strategy):
		"""
		execute strategy - fuzz all inputs and make sure 
		they have been sanitized
		"""
		vectors = strategy._getVectors()

		logger.info("Checking that input has been sanitized, random is currently set to " \
						+ strategy.options.random)

		for page in pages:
			forms = page.get("inputs").get("forms")
			url = page.get("url")
			
			if strategy.options.random == "False" or strategy.options.random == "false":
		
				# sequentially fuzz forms..
				for form in forms:
					for vector in vectors:
						response = strategy._executeVector(url, vector, form)

						if response != None:
							self._checkForSanitization(vector, response, url)
			else:
			
				if len(forms) > 0:
					form = random.choice(forms) # randomly choose a form

					for vector in vectors:
						response = strategy._executeVector(url, vector, form)

						if response != None:
							self._checkForSanitization(vector, response, url)

		logger.info("Sanitization checks complete")


	def _checkForSQLExploit(self, response, url):
		"""
		checks if the response has a sql exploit 
		"""
		
		if "MySQL " in response.text:
			logger.info("Possible SQL exploit found on page: " + url)


	def _checkForSpecialChars(self, vector, response, url):
		"""
		checks to see that a few of the common special characters if in the vector has been 
		sanitized in 'da' response
		"""

		if "<" in vector or ">" in vector or "/" in vector or "\"" in vector or "?" in vector:
			if vector in response.text:
				logger.info("Special characters were not sanitized or escaped in page " + url)


	def _checkForSanitization(self, vector, response, url):
		""" 
		checks that response has been sanitized. 
		"""
		self._checkForSQLExploit(response, url)
		self._checkForSpecialChars(vector, response, url)

	

		
		


		

